<?php
// Conexión a la base de datos
$servername = "localhost";
$username = "root";
$password = "root12345";
$dbname = "proyecto_kdn";

$conn = new mysqli($servername, $username, $password, $dbname);

// Verificar la conexión
if ($conn->connect_error) {
    die("Error de conexión: " . $conn->connect_error);
}

// Obtener la lista de usuarios
function getUsers() {
    global $conn;
    $sql = "SELECT * FROM usuarios";
    $result = $conn->query($sql);
    return $result;
}

// Agregar un nuevo usuario
function addUser($fullName, $email, $age, $position, $password) {
    global $conn;
    $sql = "INSERT INTO usuarios (fullName, email, age, position, password)
            VALUES ('$fullName', '$email', '$age', '$position', '$password')";
    if ($conn->query($sql) === TRUE) {
        return true;
    } else {
        return false;
    }
}
?>

<!-- Parte de HTML y JavaScript -->
<h1>Gestión de Usuarios</h1>
<link rel="stylesheet" href="Users.css">  

<table id="userTable">
    <thead>
        <tr>
            <th>Nombre Completo</th>
            <th>Correo Electrónico</th>
            <th>Edad</th>
            <th>Puesto de Trabajo</th>
        </tr>
    </thead>
    <tbody>
    </tbody>
</table>

<h2>Agregar Nuevo Usuario</h2>
<form id="userForm">
    <label for="fullName">Nombre Completo:</label>
    <input type="text" id="fullName" name="fullName" required>

    <label for="email">Correo Electrónico:</label>
    <input type="email" id="email" name="email" required>

    <label for="age">Edad:</label>
    <input type="number" id="age" name="age" required>

    <label for="position">Puesto de Trabajo:</label>
    <input type="text" id="position" name="position" required>

    <label for="password">Contraseña:</label>
    <input type="password" id="password" name="password" required>

    <button type="submit">Agregar Usuario</button>
</form>

<script>
    // Cargar la lista de usuarios al cargar la página
    window.onload = function() {
        loadUsers();
    };

    // Función para cargar la lista de usuarios
    function loadUsers() {
        var xhr = new XMLHttpRequest();
        xhr.open("GET", "users.php", true);
        xhr.onreadystatechange = function() {
            if (xhr.readyState === 4 && xhr.status === 200) {
                var users = JSON.parse(xhr.responseText);
                var table = document.getElementById("userTable").getElementsByTagName('tbody')[0];
                table.innerHTML = '';
                for (var i = 0; i < users.length; i++) {
                    var row = table.insertRow(-1);
                    row.insertCell(0).textContent = users[i].fullName;
                    row.insertCell(1).textContent = users[i].email;
                    row.insertCell(2).textContent = users[i].age;
                    row.insertCell(3).textContent = users[i].position;
                }
            }
        };
        xhr.send();
    }

    // Evento de envío del formulario de nuevo usuario
    document.getElementById("userForm").addEventListener("submit", function(event) {
        event.preventDefault();
        var fullName = document.getElementById("fullName").value;
        var email = document.getElementById("email").value;
        var age = document.getElementById("age").value;
        var position = document.getElementById("position").value;
        var password = document.getElementById("password").value;

        var xhr = new XMLHttpRequest();
        xhr.open("POST", "users.php", true);
        xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
        xhr.onreadystatechange = function() {
            if (xhr.readyState === 4 && xhr.status === 200) {
                if (xhr.responseText === "true") {
                    alert("Usuario agregado exitosamente.");
                    loadUsers();
                    document.getElementById("userForm").reset();
                } else {
                    alert("Error al agregar el usuario.");
                }
            }
        };
        xhr.send("fullName=" + fullName + "&email=" + email + "&age=" + age + "&position=" + position + "&password=" + password);
    });
</script>
